---
title: "PHQ9"
author: "Yijin Xiang"
date: "November 15, 2019"
output:
  html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE,fig.width = 10)
knitr::opts_knit$set(root.dir = "/Volumes/bga_lab/DATA_REPOSITORIES/MAPME/SCORING/MULTIWAVES/REPORT/Descriptive Reports")#set working directory
```

This is an R Markdown document for PHQ9 data across waves. Patient Health Questionnaire (PHQ9) is a brief depression severity measure, rating the frequency of the symptoms which factors into the scoring severity index.The scale uses a 0(Not at all) to 3 (Nearly every day) response format.The possible range is 0-27.PHQ9 scores of 5, 10, 15 and 20 represents mild, moderate, moderately severe and severe depression.303, 255 and 227 participants finished the PHQ9 instrument respectively. 216 participants finished PHQ9 instrument for all three waves. 

```{r load library and import dataset,echo=FALSE, message=FALSE, warning=FALSE}
# data.table - for reading in / writing out files
#install.packages("data.table")
library("data.table")
#dplyr - for susbset specific columns containing certain words
#install.packages("dplyr")
library("dplyr")
#ggplot2 - for ploting
#install.packages("ggplot2")
library(ggplot2)
#ggpubr - for adding statistics
#install.packages("ggpubr") 
library("ggpubr")
#ggrepel - repel overlapping text
# install.packages("ggrepel")
library(ggrepel)
#knitr - for printing the dataframe in a better form
#install.packages("knitr")
library("knitr")
#tidyr - for reshaping the data(for plot sleep duration in weekday and weekend in one histogram)
#install.packages("tidyr")
library(tidyr)
# wesanderson - change the color pattern
#install.packages("wesanderson")
library(wesanderson)
#install.packages("gee")
library(gee)
#install.packages("kableExtra")
library(kableExtra)
##read in latest .csv from redcap
red_w1<-fread("/Volumes/bga_lab/DATA_REPOSITORIES/MAPME/SCORING/WAVE1/MAPme_Data_w1_clean.csv")
phq9_data_w1<- fread("/Volumes/bga_lab/DATA_REPOSITORIES/MAPME/SCORING/WAVE1/SCORED_OUTPUT/FINALIZED_WAVE1/PHQ9_w1_June122019.csv")
phq9_data_w2<- fread("/Volumes/bga_lab/DATA_REPOSITORIES/MAPME/SCORING/WAVE2/SCORED_OUTPUT/PHQ9_w2_June262019.csv")
phq9_data_w3<- fread("/Volumes/bga_lab/DATA_REPOSITORIES/MAPME/SCORING/WAVE3/SCORED_OUTPUT/PHQ9_w3_Sep272019.csv")
phq9_data_w4<- fread("/Volumes/bga_lab/DATA_REPOSITORIES/MAPME/SCORING/WAVE4/SCORED_OUTPUT/PHQ9_w4_Feb142020.csv")
demographic<-red_w1[,c(1,28,637)]
```

```{r susbset dataset relevant to PHQ9}
####merge PHQ9 data
PHQ9_data<-merge(merge(merge(demographic,phq9_data_w1),
                 merge(phq9_data_w2[,c(1,12,13)],phq9_data_w3[,c(1,11,12)],all = TRUE), all = TRUE),
                  phq9_data_w4[,c(1,11,12)],all = TRUE)

# Change demographic variables into factors
PHQ9_data$gender<-factor(PHQ9_data$sex,labels=c("Female","Male"))
PHQ9_data$campus<-factor(PHQ9_data$campus)

# What about using the new function to achieve the same task:
source("/Volumes/bga_lab/DATA_REPOSITORIES/MAPME/SCORING/TOOLS/TOOLS.R")
PHQ9_long<-w2l(data = PHQ9_data, wave = c(1,2,3,4)) #It didn't gather well bacause the name styles in different waves are inconsistent, so I need to rename something.
```
```{r}
PHQ9_long$phq_riskgroup <- factor(PHQ9_long$phq_riskgroup,labels = c("None-Minimal(0-4)", "Mild(5-9)", "Moderate(10-14)", "Moderately Severe(15-19)", "Severe (20+)"))
```
```{r}
#########################################
#Prepare the data for phq9 severity: n(%) 
e<-PHQ9_long %>%
  filter(!is.na(phq_riskgroup)) %>%
  count(wave,phq_riskgroup)%>%
  group_by(wave) %>% 
  mutate(prop = paste(round(prop.table(n),digits = 2),")",sep = "") )
b<-unite(e,freq,c(n,prop), sep = " (")
#Prepare the data for phq9 total score: mean(SD)
d<-PHQ9_long %>%
  group_by(wave) %>% 
  summarise(Mean = round(mean(totalphq9scores,na.rm = TRUE),digits = 2), SD = paste(round(sd(totalphq9scores,na.rm = TRUE), digits = 2),")",sep = "" ))
f<-unite(d,Mean,c(Mean,SD), sep = " (")
#Generate a summary table
temp.result=matrix(NA,4,6)
for (i in 1:4){
  #fill the data for PHQ9 severity into the table for 4 waves(4 rows) and 5 categories(5 columns)
  temp.result[i,c(1:5)]<-t(b[c(5*i-4:5*i),3])
  #fill the data for PHQ9 total score into the table for 4 waves (4 rows)
  temp.result[i,6]<-as.character(f[i,2])
}
# Format the summary table for visualization
row.names(temp.result)<-levels(factor(PHQ9_long$wave))
colnames(temp.result)<-c("None-Minimal(0-4)","Mild(5-9)","Moderate(10-14)","Moderately Severe(15-19)", "Severe (20+)","PHQ9 Total Score")
kable(temp.result, row.names = TRUE,caption="Table 1.PPHQ-9 Depression Severity across Waves")%>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")%>%
  footnote(general = "Categorical Variables(risk group) were present as n(%) and continuous variable(total score) was present as mean(sd).",
           general_title = "Note: ",
           footnote_as_chunk = T, title_format = c("bold")
  )
```

```{r}
#Generate the plots
PHQ9_long %>%
  filter(!is.na(phq_riskgroup))  %>%
  count(phq_riskgroup,wave) %>% 
  group_by(wave)%>% 
  mutate(pct = prop.table(n))%>%
  ggplot(aes(x=wave,y=n,fill=phq_riskgroup)) + geom_bar(position = "fill",stat = "identity") +
  geom_text(aes(label = scales::percent(pct)), position=position_fill(vjust=0.5))+
  labs(y="Percentage",title="Figure1. PHQ-9 Depression Severity across Waves",fill="PHQ-9 Depression Severity", x="Wave")+
  scale_fill_manual(values=wes_palette("Zissou1"))
```



Use the model below to reveal the relationship between time and PHQ9 total socre  
$Y_{ij}=\beta_0+\beta_1Time_2+\beta_2Time_3+\beta_3Time_4$.
```{r}

#create a model
model1<-lm(totalphq9scores~factor(wave),data = PHQ9_long)

kable(round(summary(model1)$coefficient,2),caption="Table 2. Results of Linear Regression to estimate the correlation between waves and PHQ9 Total Score")%>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")%>%
  footnote(general = "Linear regression without considering the correlation between measurement",
           general_title = "Note: ",
           footnote_as_chunk = T, title_format = c("bold")
  )
resid1<-model1$residuals
cor1<-cor(matrix(resid1,ncol=4, byrow = TRUE))
cor1
kable(round(summary(gee(totalphq9scores~factor(wave),id=record_id,data = PHQ9_long,corstr = "unstructured"))$coefficient,2),caption="Table 2. Results of GEE to estimate the correlation between waves and PHQ9 Total Score")%>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")%>%
  footnote(general = "Generalized estimating equation Model",
           general_title = "Note: ",
           footnote_as_chunk = T, title_format = c("bold")
  )
```
Conclusion: The measurment in one time-point is correlated with measurment on near time points and the correlation declines with the duration between two measurements increases. Unstructure correlation matrix will be considered when conducting gee models. The results gained from two models are similar, indicating the PHQ9 total score significaly increases with time passing.
```{r}
PHQ9_long%>%
  group_by(wave,gender) %>%
  summarise(Mean = mean(totalphq9scores,na.rm = TRUE),sd=sd(totalphq9scores,na.rm = TRUE) ) %>%
  ggplot(aes(x=wave, y=Mean, group=gender,color=gender, shape=gender)) +
  geom_errorbar(aes(ymin=Mean-1.96*sd, ymax=Mean+1.96*sd), width=.1, position=position_dodge(0.05)) +
  geom_line()+
  geom_point()+
  scale_color_brewer(palette="Paired")+
  geom_text(aes(label=round(Mean,2),hjust = 1,vjust= -0.5))+
  labs(title="Figure 3. Distribution of PHQ-9 Total Score across Waves,by Sex", y="PHQ-9 Total Score")+ theme_classic() + scale_color_manual(values=c('#990000','#000033'))

temp.result=matrix(NA,4,5)
row.names(temp.result)<-levels(factor(PHQ9_long$wave))
for (wave in levels(factor(PHQ9_long$wave))) {
  data=PHQ9_long[PHQ9_long$wave==wave,]
  result<-t.test(data$totalphq9scores,data$sex)
  male=round(mean(data[data$sex==1,"totalphq9scores"],na.rm = TRUE),2)
  female=round(mean(data[data$sex==0,"totalphq9scores"],na.rm = TRUE),2)
  temp.result[rownames(temp.result)==wave,c(3:4)]<-round(result$conf.int[1:2],2)
  temp.result[rownames(temp.result)==wave,1]<-male
  temp.result[rownames(temp.result)==wave,2]<-female
  temp.result[rownames(temp.result)==wave,5]<-ifelse(result$p.value<=0.0001,'<0.0001',result$p.value)
}

colnames(temp.result)=c('Male','Female','Lower 95%','Upper 95%', 'P-value')
kable(temp.result,row.names = TRUE,caption="Table 3.PHQ9 Total Score acorss Waves, by Sex")%>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")%>%
  footnote(general = "Two sample student t-test was applied to compare the PHQ9 Total in two categories",
           general_title = "Note: ",
           footnote_as_chunk = T, title_format = c("bold")
  )
```
Conclusion:The average PHQ9 total score across waves among female is larger than which among males, the difference is significant for all three waves.  
```{r}
PHQ9_long %>%
  filter(!is.na(phq_riskgroup)& !is.na(gender))  %>%
  count(phq_riskgroup,wave,gender) %>% 
  group_by(wave,gender)%>% 
  mutate(pct = prop.table(n))%>%
  ggplot(aes(x=gender,y=n,fill=phq_riskgroup)) + geom_bar(position = "fill",stat = "identity") +
  geom_text(aes(label = scales::percent(pct)), position=position_fill(vjust=0.5)) + 
  facet_wrap(~wave,  ncol=4) +
  labs(y="Percentage",title="Figure 4.PHQ-9 Depression Severity across Waves, by Sex",fill="PHQ-9 Depression Severity", x="Wave")+
  scale_fill_manual(values=wes_palette("Zissou1"))
temp.result=matrix(NA,4,1)
row.names(temp.result)<-levels(factor(PHQ9_long$wave))
for (wave in levels(factor(PHQ9_long$wave))) {
  data=PHQ9_long[PHQ9_long$wave==wave,]
  tbl=table(data$gender,data$phq_riskgroup)
  result<-chisq.test(tbl)
  result$p.value
  temp.result[rownames(temp.result)==wave,1]<-ifelse(result$p.value<=0.0001,'<0.0001',round(result$p.value,4))
}

colnames(temp.result)=c( 'P-value')
kable(temp.result,row.names = TRUE,caption="Table 4.PHQ9 Total Score acorss Waves, by Sex")%>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")%>%
  footnote(general = "Chi-squared Test of Independece was applied to compare the PHQ9 riskgroup in two categories",
           general_title = "Note: ",
           footnote_as_chunk = T, title_format = c("bold")
  )
```
Possible interaction of sex is found in figure(The rate of total score change is not the same between two sex groups).

Use the model below to reveal the relationship between time, sex and PHQ9 total socre. Backwards elimination(model selection) was used to decided the best fit.
$Y_{ij}=\beta_0+\beta_1Time_2+\beta_2Time_3+\beta_3Time_4+\beta_4Sex_i+\beta_5Time_2*Sex_i+\beta_6Time_3*Sex_i+\beta_7Time_4*Sex_i$.  
```{r}
model2<-lm(totalphq9scores~factor(wave)*sex,data = PHQ9_long)

kable(round(summary(model2)$coefficient,2),caption="Table 4.  Results of Linear Regression to Estimate the Correlation between Waves and PHQ9 Total Score")%>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")%>%
  footnote(general = "Linear regression without considering the correlation between measurement",
           general_title = "Note: ",
           footnote_as_chunk = T, title_format = c("bold")
  )
```

```{r}
model2_step<-step(model2)
kable(round(summary(model2_step)$coefficient,2),caption="Table 5. Results of Final Linear Regression to Estimate the Correlation between Waves and PHQ9 Total Score after Backwards Elimination")%>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")%>%
  footnote(general = "Linear regression without considering the correlation between measurement",
           general_title = "Note: ",
           footnote_as_chunk = T, title_format = c("bold")
  )
kable(round(summary(gee(totalphq9scores~factor(wave)*sex,id=record_id,data = PHQ9_long,corstr = "unstructured"))$coefficient,2),caption="Table 6. Results of GEE to estimate the correlation between waves and PHQ9 Total Score")%>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")%>%
  footnote(general = "Generalized estimating equation Model",
           general_title = "Note: ",
           footnote_as_chunk = T, title_format = c("bold")
  )
```
Conclusion: Sex should be also considered into model when analyzing the change of PSS.However, it is not an interaction term, which means that the changing rate of PHQ9 total score across waves doesn't differ within different sex group.

```{r}

PHQ9_long%>%
  group_by(wave,campus) %>%
  summarise(Mean = mean(totalphq9scores,na.rm = TRUE),sd=sd(totalphq9scores,na.rm = TRUE) ) %>%
  ggplot(aes(x=wave, y=Mean, group=campus,color=campus, shape=campus)) +
  geom_errorbar(aes(ymin=Mean-1.96*sd, ymax=Mean+1.96*sd), width=.1, position=position_dodge(0.05)) +
  geom_line()+
  geom_point()+
  scale_color_brewer(palette="Paired")+
  geom_text_repel(aes(label=round(Mean,2)))+
  labs(title="Distribution of PHQ-9 Total Score across Waves,by Campus", y="PHQ-9 Total Score")+ theme_classic() + scale_color_manual(values=c('#990000','#000033'))

```
```{r}
PHQ9_long %>%
  filter(!is.na(phq_riskgroup))  %>%
  count(phq_riskgroup,wave,campus) %>% 
  group_by(wave,campus)%>% 
  mutate(pct = prop.table(n))%>%
  ggplot(aes(x=campus,y=n,fill=phq_riskgroup)) + geom_bar(position = "fill",stat = "identity") +
  geom_text(aes(label = scales::percent(pct)), position=position_fill(vjust=0.5)) + 
  facet_wrap(~wave,  ncol=4)  +
  labs(y="Percentage",title="PHQ-9 Depression Severity across Waves, by Campus",fill="PHQ-9 Depression Severity", x="Wave")+
  scale_fill_manual(values=wes_palette("Zissou1"))
temp.result=matrix(NA,4,1)
row.names(temp.result)<-levels(factor(PHQ9_long$wave))
for (wave in levels(factor(PHQ9_long$wave))) {
  data=PHQ9_long[PHQ9_long$wave==wave,]
  tbl=table(data$campus,data$phq_riskgroup)
  result<-chisq.test(tbl)
  result$p.value
  temp.result[rownames(temp.result)==wave,1]<-ifelse(result$p.value<=0.0001,'<0.0001',round(result$p.value,4))
}

colnames(temp.result)=c( 'P-value')
kable(temp.result,row.names = TRUE,caption="Table 4.PHQ9 Total Score acorss Waves, by Campus")%>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")%>%
  footnote(general = "Chi-squared Test of Independece was applied to compare the PHQ9 riskgroup in two categories",
           general_title = "Note: ",
           footnote_as_chunk = T, title_format = c("bold")
  )
```
Conclusion: There is no difference of neither PHQ9 total score or severity groups among differnet campus.  

Summary: The mean of PHQ9 total score increases with time enrolled in to our study. We should take sex into consideration when analyzing the PHQ9 total score. 
Limitations: We found the interaction of gender and PHQ9 severity from the plots but we didn't do logistics regression to quantify the relationship. We need to figure out whether it is a nominal or ordinal logistic regression.Model diagnosis should be conducted to indicate the performance of the model.

